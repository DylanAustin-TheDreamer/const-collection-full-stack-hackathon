{% extends 'base.html' %}
{% load static %}

{% block title %}Shopping Basket | Const Collection{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/basket.css' %}">
{% endblock %}

{% block content %}
  <!-- 
    SHOPPING BASKET PAGE
    Purpose: Display user's shopping cart with item management
    Features: View items, update quantities, remove items, proceed to checkout
  -->
  
  <div class="container mt-4 mb-5">
    <!-- Page Header -->
    <div class="row mb-4 basket-header">
        <div class="col-12">
            <h1 class="display-5">Shopping Basket</h1>
            <div class="accent-stripe"></div>
            <p class="text-muted">Review your selected artworks before checkout</p>
        </div>
    </div>

    {% if basket_items %}
      <!-- Basket Items Section -->
      <div class="row">
        <!-- Items List Column -->
        <div class="col-lg-8">
          <div class="basket-card mb-4">
            <div class="card-header">
              <h5 class="mb-0">
                Your Items ({{ basket_items|length }})
              </h5>
            </div>
            <div class="card-body p-0">
              <!-- Basket Items Table -->
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Artwork</th>
                      <th scope="col">Details</th>
                      <th scope="col" class="text-center">Quantity</th>
                      <th scope="col" class="text-end">Price</th>
                      <th scope="col" class="text-end">Subtotal</th>
                      <th scope="col" class="text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for item in basket_items %}
                      <!-- Individual Basket Item Row -->
                      <tr id="basket-item-{{ item.id }}">
                        <!-- Artwork Image and Title -->
                        <td style="width: 200px;">
                          <div class="d-flex align-items-center">
                            {% if item.display_artwork.image %}
                              <img 
                                src="{{ item.display_artwork.image.url }}" 
                                alt="{{ item.display_artwork.title }}"
                                class="img-thumbnail me-2"
                                style="width: 80px; height: 80px; object-fit: cover;"
                              >
                            {% else %}
                              <div 
                                class="bg-light me-2 d-flex align-items-center justify-content-center"
                                style="width: 80px; height: 80px;"
                              >
                                <i class="bi bi-image text-muted"></i>
                              </div>
                            {% endif %}
                            <div>
                              <strong>
                                  <a 
                                  href="{% url 'collections_app:artwork_detail' item.display_artwork.pk %}"
                                  class="text-decoration-none"
                                >
                                  {{ item.display_artwork.title }}
                                </a>
                              </strong>
                            </div>
                          </div>
                        </td>

                        <!-- Artwork Details -->
                        <td>
                          <small class="text-muted">
                            <div><strong>Artist:</strong> {{ item.display_artwork.artist.name }}</div>
                            {% if item.variant %}
                              <div><strong>Format:</strong> {{ item.variant.get_medium_display }}</div>
                            {% else %}
                              {% if item.display_artwork.medium %}
                                <div><strong>Medium:</strong> {{ item.display_artwork.medium }}</div>
                              {% endif %}
                            {% endif %}
                            {% if item.display_artwork.get_size_display %}
                              <div><strong>Size:</strong> {{ item.display_artwork.get_size_display }}</div>
                            {% endif %}
                          </small>
                        </td>

                        <!-- Quantity Control -->
                        <td class="text-center" style="width: 150px;">
                          <form 
                            method="post" 
                            action="{% url 'collections_app:update_basket_item' item.id %}"
                            class="d-inline update-quantity-form"
                          >
                            {% csrf_token %}
                            <div class="input-group input-group-sm">
                              <button 
                                class="btn btn-outline-secondary" 
                                type="button"
                                onclick="decrementQuantity({{ item.id }})"
                              >
                                <i class="bi bi-dash"></i>
                              </button>
                              <input 
                                type="number" 
                                class="form-control text-center" 
                                name="quantity"
                                id="quantity-{{ item.id }}"
                                value="{{ item.quantity }}"
                                min="1"
                                max="10"
                                style="max-width: 60px;"
                              >
                              <button 
                                class="btn btn-outline-secondary" 
                                type="button"
                                onclick="incrementQuantity({{ item.id }})"
                              >
                                <i class="bi bi-plus"></i>
                              </button>
                            </div>
                          </form>
                        </td>

                        <!-- Price -->
                        <td class="text-end">
                          <strong>${{ item.price_at_addition|floatformat:2 }}</strong>
                          {% if item.variant and item.variant.currency and item.variant.currency != item.display_artwork.currency %}
                            <div class="small text-muted">{{ item.variant.currency }}</div>
                          {% endif %}
                        </td>

                        <!-- Subtotal -->
                        <td class="text-end">
                          <strong class="text-primary" id="subtotal-{{ item.id }}">
                            ${{ item.get_subtotal|floatformat:2 }}
                          </strong>
                        </td>

                        <!-- Remove Button -->
                        <td class="text-center">
                          <form 
                            method="post" 
                            action="{% url 'collections_app:remove_from_basket' item.id %}"
                            class="d-inline"
                            onsubmit="return confirm('Remove {{ item.display_artwork.title }} from basket?');"
                          >
                            {% csrf_token %}
                            <button 
                              type="submit" 
                              class="btn btn-sm btn-outline-danger"
                              title="Remove from basket"
                            >
                              <i class="bi bi-trash"></i>
                            </button>
                          </form>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Continue Shopping Button -->
          <div class="mb-4">
              <a 
                href="{% url 'collections_app:artwork_list' %}" 
                class="btn btn-minimal"
              >
                <i class="bi bi-arrow-left"></i> Continue Shopping
              </a>            <!-- Clear Basket Button -->
            <form 
              method="post" 
              action="{% url 'collections_app:clear_basket' %}"
              class="d-inline ms-2"
              onsubmit="return confirm('Clear all items from your basket?');"
            >
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger">
                <i class="bi bi-trash"></i> Clear Basket
              </button>
            </form>
          </div>
        </div>

        <!-- Order Summary Column -->
        <div class="col-lg-4">
          <div class="summary-card sticky-top" style="top: 20px;">
            <div class="summary-header">
              <h5 class="mb-0">Order Summary</h5>
            </div>
            <div class="card-body">
              <!-- Order Summary Details -->
              <div class="d-flex justify-content-between mb-2">
                <span>Items:</span>
                <strong>{{ item_count }}</strong>
              </div>
              
              <div class="d-flex justify-content-between mb-2">
                <span>Subtotal:</span>
                <strong id="basket-subtotal">${{ total_price|floatformat:2 }}</strong>
              </div>
              
              <hr>
              
              <div class="d-flex justify-content-between mb-3">
                <strong>Total:</strong>
                <strong class="text-success fs-4" id="basket-total">
                  ${{ total_price|floatformat:2 }}
                </strong>
              </div>
              
              <!-- Checkout Button -->
              <div class="d-grid gap-2">
                {% if user.is_staff %}
                  {# Admin/Staff Only Checkout Button #}
                  <a 
                    href="{% url 'collections_app:checkout' %}" 
                    class="btn btn-success btn-lg"
                  >
                    <i class="bi bi-credit-card"></i> Admin Test Checkout
                  </a>
                  <div class="alert alert-info mt-2 mb-0">
                    <small>
                      <i class="bi bi-info-circle"></i> 
                      Admin test mode: Payment processing is available for testing purposes only.
                    </small>
                  </div>
                {% else %}
                  {# Regular User Message #}
                  <button 
                    class="btn btn-secondary btn-lg" 
                    disabled
                  >
                    <i class="bi bi-clock"></i> Checkout Coming Soon
                  </button>
                  <div class="alert alert-warning mt-2 mb-0">
                    <small>
                      <i class="bi bi-exclamation-circle"></i> 
                      Our payment system is currently under maintenance. Thank you for your patience!
                    </small>
                  </div>
                {% endif %}
              </div>
              
              <!-- Security Badge -->
              <div class="mt-3 text-center">
                <small class="text-muted">
                  <i class="bi bi-shield-check"></i> 
                  Secure Checkout with Stripe
                </small>
              </div>
            </div>
          </div>

          <!-- Shipping Information -->
          <div class="card shadow-sm mt-3">
            <div class="card-body">
              <h6 class="card-title">
                <i class="bi bi-info-circle"></i> Shipping Information
              </h6>
              <small class="text-muted">
                <ul class="mb-0">
                  <li>Free shipping on orders over $500</li>
                  <li>Secure packaging for all artworks</li>
                  <li>Certificate of authenticity included</li>
                  <li>14-day return policy</li>
                </ul>
              </small>
            </div>
          </div>
        </div>
      </div>
    {% else %}
      <!-- Empty Basket Message -->
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-body text-center py-5">
              <i class="bi bi-cart-x display-1 text-muted mb-3"></i>
              <h3>Your basket is empty</h3>
              <p class="text-muted mb-4">
                Start adding artworks to your basket to make a purchase.
              </p>
              <a 
                href="{% url 'collections_app:artwork_list' %}" 
                class="btn btn-primary btn-lg"
              >
                <i class="bi bi-palette"></i> Browse Artworks
              </a>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  </div>

  <!-- JavaScript for Quantity Controls -->
  <!-- quantity controls handled in static/js/main.js -->

  <!-- Include Bootstrap Icons if not already included -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
{% endblock %}
