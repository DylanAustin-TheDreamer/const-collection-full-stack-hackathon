{% extends 'base.html' %}

{% block title %}Events | Const Collection{% endblock %}

{% block content %}
  <div class="container mt-4">
    <h2>Events</h2>
    <!-- Scoped styles: two-column media grid with thumbnails that fill their container and align to the cover image -->
    <style>
      /* ensure the left and cover columns stretch to the same height */
      .collection-section > .row {
        align-items: stretch;
      }

      /* left column should be a column flex so top + bottom stack and bottom can grow */
      .collection-left {
        display: flex;
        flex-direction: column;
      }

      /* left-bottom should take remaining space so media grid fills the column */
      .left-bottom {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        position: relative; /* allow absolute overlay inside */
      }

      /* two column grid for assigned media; grid fills the left-bottom area */
      .cc-media-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        align-items: stretch;
        grid-auto-rows: 1fr; /* make rows equal height and stretch */
        height: 100%;
      }

      /* each grid item stretches and uses flex so the card fills the cell */
      .cc-media-item {
        display: flex;
        height: 100%;
      }

      /* make the card fill the grid cell height */
      .collection-card-fill {
        height: 100%;
        min-height: 140px; /* fallback minimum */
        overflow: hidden;
        display: block;
        width: 100%;
      }

      .collection-card-fill .card-media {
        height: 100%;
        display: block;
      }

      /* make images and videos cover the available area */
      .collection-card-fill img,
      .collection-card-fill video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      /* ensure cover column media fills its column height */
      /* center the cover media vertically and horizontally */
      .collection-cover {
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      .collection-cover-media {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain; /* show whole cover centered */
        display: block;
      }

      /* helper: cover shown inside the media grid only on small screens */
      .cover-in-grid { display: block; }
      @media (min-width: 768px) {
        .cover-in-grid { display: none !important; }
      }

      @media (max-width: 767.98px) {
        /* on small screens collapse to a single column grid */
        .cc-media-grid { grid-template-columns: 1fr; grid-auto-rows: auto; height: auto; }
        .collection-section > .row { align-items: stretch; }
      }
      /* About overlay: positioned over media, does not push layout */
      .exhibition-about-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        z-index: 40;
        background: var(--surface, #fff);
        color: var(--text-primary, #111);
        padding: 1rem;
        box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        border-radius: 6px;
        max-height: 70vh;
        overflow: auto;
        /* hide native scrollbars but keep scrolling functional */
        -ms-overflow-style: none; /* IE and Edge */
        scrollbar-width: none; /* Firefox */
      }
      .exhibition-about-overlay::-webkit-scrollbar { display: none; } /* WebKit */
      /* inside the about overlay: responsive thumbnails grid */
      .exhibition-about-overlay .about-media-grid {
        display: grid;
        gap: 0.5rem;
        grid-template-columns: 1fr;
        margin-top: 0.75rem;
      }
      @media (min-width: 768px) {
        .exhibition-about-overlay .about-media-grid { grid-template-columns: repeat(2, 1fr); }
      }
      @media (min-width: 992px) {
        .exhibition-about-overlay .about-media-grid { grid-template-columns: repeat(3, 1fr); }
      }
      .exhibition-about-overlay .about-thumb {
        overflow: hidden;
        aspect-ratio: 4 / 3;
        border-radius: 4px;
        background: var(--background, #f8f9fa);
        display: block;
      }
      .exhibition-about-overlay .about-thumb img,
      .exhibition-about-overlay .about-thumb video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      /* Artwork header: slightly larger and subtle underline using theme accent */
      .exhibition-about-overlay .about-art-header {
        font-size: 1.06rem;
        font-weight: 600;
        position: relative;
        padding-bottom: 0.24rem;
        margin-bottom: 0.5rem;
      }
      .exhibition-about-overlay .about-art-header::after {
        content: "";
        position: absolute;
        left: 0;
        bottom: 0;
        height: 2px;
        width: 36%;
        background: var(--link-accent, #0d6efd);
        opacity: 0.25;
        border-radius: 2px;
      }
    </style>

    <section class="my-4">
      <h3>Upcoming Exhibitions</h3>
      {% if upcoming_exhibitions %}
        <div class="row">
          {% for exhibition in upcoming_exhibitions %}
            <div class="col-12 mb-4">
              <div class="card deep-card-shadow">
                <div class="card-body">
                  <div class="collection-section">
                    <div class="row">
                      {% if exhibition.cover_image %}
                        <div class="col-12 col-md-7 d-flex flex-column collection-left collection-left-col">
                      {% else %}
                        <div class="col-12 d-flex flex-column collection-left">
                      {% endif %}
                          <div class="left-top">
                            <div class="row">
                              <div class="col-12">
                                <h5 class="collection-title">{{ exhibition.title }}</h5>
                                <div class="collection-actions mb-2">
                                  <a class="btn btn-outline-secondary me-2" data-bs-toggle="collapse" href="#desc-{{ exhibition.id }}" role="button" aria-expanded="false" aria-controls="desc-{{ exhibition.id }}">Details</a>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div class="left-bottom mt-2">
                            <div class="collapse exhibition-about-overlay" id="desc-{{ exhibition.id }}">
                              <div class="card card-body mb-3">
                                <p class="mb-1">{{ exhibition.description }}</p>

                                <div class="mt-1">
                                  {% if exhibition.start_date or exhibition.end_date %}
                                    <p class="mb-1"><strong>Date:</strong> {% if exhibition.start_date %}{{ exhibition.start_date }}{% endif %}{% if exhibition.end_date %} &ndash; {{ exhibition.end_date }}{% endif %}</p>
                                  {% endif %}
                                  {% if exhibition.start_time or exhibition.end_time %}
                                    <p class="mb-0"><strong>Time:</strong> {% if exhibition.start_time %}{{ exhibition.start_time }}{% endif %}{% if exhibition.end_time %} &ndash; {{ exhibition.end_time }}{% endif %}</p>
                                  {% endif %}
                                </div>

                                {% if exhibition.location %}
                                  <h6 class="mt-2">Location</h6>
                                  <p>{{ exhibition.location }}</p>
                                {% endif %}

                                <h6 class="mt-3 about-art-header">Artwork displayed in this exhibition</h6>
                                <div class="about-media-grid">
                                  {% for ea in exhibition.exhibition_arts.all %}
                                    {% if ea.art and ea.art.image %}
                                      <div class="about-thumb">
                                        <img src="{{ ea.art.image.url }}" alt="{{ ea.art.title }}">
                                      </div>
                                    {% endif %}
                                  {% empty %}
                                    <p class="text-muted">No assigned art.</p>
                                  {% endfor %}
                                </div>
                              </div>
                            </div>

                            <div class="cc-media-grid collection-detail-grid">
                              {# show cover image first inside the grid so it appears before assigned media #}
                              {% if exhibition.cover_image %}
                                <div class="cc-media-item d-block d-md-none">
                                  <div class="card collection-card-fill">
                                    <div class="card-media">
                                      {% with url=exhibition.cover_image.url %}
                                        {% if '.mp4' in url or '.webm' in url or '.ogg' in url %}
                                          <video class="collection-detail-img" autoplay muted playsinline loop preload="metadata" poster="{{ url }}">
                                            <source src="{{ url }}" type="video/mp4">
                                            Your browser does not support the video tag.
                                          </video>
                                        {% else %}
                                          <img src="{{ url }}" class="collection-detail-img" alt="{{ exhibition.title }} cover" loading="lazy" onerror="this.style.display='none'">
                                        {% endif %}
                                      {% endwith %}
                                    </div>
                                  </div>
                                </div>
                              {% endif %}
                              {% for em in exhibition.exhibition_media.all %}
                                {% if em.media and em.media.file %}
                                  <div class="cc-media-item">
                                    <div class="card collection-card-fill">
                                      <div class="card-media">
                                        {% if em.media.media_type == 'video' %}
                                          <video class="collection-detail-img" autoplay muted playsinline loop preload="metadata" poster="{{ em.media.file.url }}">
                                            <source src="{{ em.media.file.url }}" type="video/mp4">
                                            Your browser does not support the video tag.
                                          </video>
                                        {% else %}
                                          <img src="{{ em.media.file.url }}" class="collection-detail-img" alt="{{ exhibition.title }} media" loading="lazy" onerror="this.style.display='none'">
                                        {% endif %}
                                      </div>
                                    </div>
                                  </div>
                                {% endif %}
                              {% empty %}
                                <p class="text-muted">No media assigned.</p>
                              {% endfor %}
                            </div>
                          </div>
                        </div>

                      {% if exhibition.cover_image %}
                        <div class="col-12 col-md-5 collection-cover-col d-none d-md-block">
                          {% with url=exhibition.cover_image.url %}
                            <div class="collection-cover">
                              {% if '.mp4' in url or '.webm' in url or '.ogg' in url %}
                                <video class="collection-cover-media" autoplay muted playsinline loop preload="metadata">
                                  <source src="{{ url }}" type="video/mp4">
                                  Your browser does not support the video tag.
                                </video>
                              {% else %}
                                <img src="{{ url }}" class="collection-cover-media" alt="{{ exhibition.title }}">
                              {% endif %}
                            </div>
                          {% endwith %}
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p>No upcoming exhibitions.</p>
      {% endif %}
    </section>

    <section class="my-4">
      <h3>Past Exhibitions</h3>
      {% if previous_exhibitions %}
        <div class="row">
          {% for exhibition in previous_exhibitions %}
            <div class="col-12 mb-4">
              <div class="card deep-card-shadow">
                <div class="card-body">
                  <div class="collection-section">
                    <div class="row">
                      {% if exhibition.cover_image %}
                        <div class="col-12 col-md-7 d-flex flex-column collection-left collection-left-col">
                      {% else %}
                        <div class="col-12 d-flex flex-column collection-left">
                      {% endif %}
                          <div class="left-top">
                            <div class="row">
                              <div class="col-12">
                                <h5 class="collection-title">{{ exhibition.title }}</h5>
                                <div class="collection-actions mb-2">
                                  <a class="btn btn-outline-secondary me-2" data-bs-toggle="collapse" href="#desc-{{ exhibition.id }}" role="button" aria-expanded="false" aria-controls="desc-{{ exhibition.id }}">Details</a>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div class="left-bottom mt-2">
                            <div class="collapse exhibition-about-overlay" id="desc-{{ exhibition.id }}">
                              <div class="card card-body mb-3">
                                <p class="mb-1">{{ exhibition.description }}</p>

                                <div class="mt-1">
                                  {% if exhibition.start_date or exhibition.end_date %}
                                    <p class="mb-1"><strong>Date:</strong> {% if exhibition.start_date %}{{ exhibition.start_date }}{% endif %}{% if exhibition.end_date %} &ndash; {{ exhibition.end_date }}{% endif %}</p>
                                  {% endif %}
                                  {% if exhibition.start_time or exhibition.end_time %}
                                    <p class="mb-0"><strong>Time:</strong> {% if exhibition.start_time %}{{ exhibition.start_time }}{% endif %}{% if exhibition.end_time %} &ndash; {{ exhibition.end_time }}{% endif %}</p>
                                  {% endif %}
                                </div>

                                {% if exhibition.location %}
                                  <h6 class="mt-2">Location</h6>
                                  <p>{{ exhibition.location }}</p>
                                {% endif %}

                                <h6 class="mt-3 about-art-header">Artwork displayed in this exhibition</h6>
                                <div class="about-media-grid">
                                  {% for ea in exhibition.exhibition_arts.all %}
                                    {% if ea.art and ea.art.image %}
                                      <div class="about-thumb">
                                        <img src="{{ ea.art.image.url }}" alt="{{ ea.art.title }}">
                                      </div>
                                    {% endif %}
                                  {% empty %}
                                    <p class="text-muted">No assigned art.</p>
                                  {% endfor %}
                                </div>
                              </div>
                            </div>

                            <div class="cc-media-grid collection-detail-grid">
                              {# show cover image first inside the grid so it appears before assigned media #}
                              {% if exhibition.cover_image %}
                                <div class="cc-media-item cover-in-grid d-block d-md-none">
                                  <div class="card collection-card-fill">
                                    <div class="card-media">
                                      {% with url=exhibition.cover_image.url %}
                                        {% if '.mp4' in url or '.webm' in url or '.ogg' in url %}
                                          <video class="collection-detail-img" autoplay muted playsinline loop preload="metadata" poster="{{ url }}">
                                            <source src="{{ url }}" type="video/mp4">
                                            Your browser does not support the video tag.
                                          </video>
                                        {% else %}
                                          <img src="{{ url }}" class="collection-detail-img" alt="{{ exhibition.title }} cover" loading="lazy" onerror="this.style.display='none'">
                                        {% endif %}
                                      {% endwith %}
                                    </div>
                                  </div>
                                </div>
                              {% endif %}
                              {% for em in exhibition.exhibition_media.all %}
                                {% if em.media and em.media.file %}
                                  <div class="cc-media-item">
                                    <div class="card collection-card-fill">
                                      <div class="card-media">
                                        {% if em.media.media_type == 'video' %}
                                          <video class="collection-detail-img" autoplay muted playsinline loop preload="metadata" poster="{{ em.media.file.url }}">
                                            <source src="{{ em.media.file.url }}" type="video/mp4">
                                            Your browser does not support the video tag.
                                          </video>
                                        {% else %}
                                          <img src="{{ em.media.file.url }}" class="collection-detail-img" alt="{{ exhibition.title }} media" loading="lazy" onerror="this.style.display='none'">
                                        {% endif %}
                                      </div>
                                    </div>
                                  </div>
                                {% endif %}
                              {% empty %}
                                <p class="text-muted">No media assigned.</p>
                              {% endfor %}
                            </div>
                          </div>
                        </div>

                      {% if exhibition.cover_image %}
                        <div class="col-12 col-md-5 collection-cover-col">
                          {% with url=exhibition.cover_image.url %}
                            <div class="collection-cover">
                              {% if '.mp4' in url or '.webm' in url or '.ogg' in url %}
                                <video class="collection-cover-media" autoplay muted playsinline loop preload="metadata">
                                  <source src="{{ url }}" type="video/mp4">
                                  Your browser does not support the video tag.
                                </video>
                              {% else %}
                                <img src="{{ url }}" class="collection-cover-media" alt="{{ exhibition.title }}">
                              {% endif %}
                            </div>
                          {% endwith %}
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p>No previous exhibitions.</p>
      {% endif %}
    </section>
  </div>
{% endblock %}
